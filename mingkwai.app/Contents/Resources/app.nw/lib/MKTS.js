// Generated by CoffeeScript 1.9.0
(function() {
  var CND, MKTS, alert, app, badge, debug, echo, help, info, log, rpr, urge, warn, whisper, ƒ;

  CND = require('cnd');

  rpr = CND.rpr.bind(CND);

  badge = '眀快排字机/MKTS';

  log = CND.get_logger('plain', badge);

  info = CND.get_logger('info', badge);

  alert = CND.get_logger('alert', badge);

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  urge = CND.get_logger('urge', badge);

  whisper = CND.get_logger('whisper', badge);

  help = CND.get_logger('help', badge);

  echo = CND.echo.bind(CND);

  app = null;

  MKTS = this;

  ƒ = function(x, precision) {
    if (precision == null) {
      precision = 2;
    }
    return x.toFixed(precision);
  };

  module.exports = function(_app) {
    app = _app;
    return MKTS;
  };

  this.ZOOM = {};

  this.ZOOM.by = (function(_this) {
    return function(factor) {
      var document, height, left, matrix, page_x, page_y, q, top, width, window, zmr, zoom_0, zoom_1;
      window = app['window'];
      q = app['jQuery'];
      document = window.document;
      width = (q(window)).width();
      height = (q(window)).height();
      left = (q(document)).scrollLeft();
      top = (q(document)).scrollTop();
      page_x = left + width / 2;
      page_y = top + height / 2;
      zmr = window.convertPointFromPageToNode(app['zoomer'].get(0), page_x, page_y);
      zoom_0 = app['zoom'];
      zoom_1 = zoom_0 * factor;
      app['zoom'] = zoom_1;
      (q('#tg')).css('left', zmr['x'] - 5);
      (q('#tg')).css('top', zmr['y'] - 5);
      matrix = app['zoomer'].css('transform');
      app['zoomer'].css('transform-origin', "top left");
      app['zoomer'].transition({
        scale: zoom_1
      }, 100, 'linear');
      echo('factor:  ', ƒ(factor));
      echo('zoom_0:  ', ƒ(zoom_0));
      echo('zoom_1:  ', ƒ(zoom_1));
      echo('width:   ', ƒ(width));
      echo('height:  ', ƒ(height));
      echo('left:    ', ƒ(left));
      echo('top:     ', ƒ(top));
      echo('page_x:  ', ƒ(page_x));
      echo('page_y:  ', ƒ(page_y));
      return echo("zoomed to [ " + (ƒ(zoom_1)) + ", ]");
    };
  })(this);

  this.ZOOM.to = (function(_this) {
    return function(zoom_1) {
      var zoom_0;
      zoom_0 = app['zoom'];
      app['zoom'] = zoom_1;
      app['zoomer'].transition({
        scale: zoom_1
      }, 100, 'linear');
      whisper('zoom_0:  ', ƒ(zoom_0));
      whisper('zoom_1:  ', ƒ(zoom_1));
      return help("zoomed to [ " + (ƒ(zoom_1)) + ", ]");
    };
  })(this);

  this.GAUGE = {};

  this.GAUGE.get_px_per_mm = (function(_this) {
    return function(app, matter) {
      var gauge, jQuery, window;
      jQuery = app.jQuery, window = app.window;
      gauge = jQuery('#meter-gauge');

      /* Since the gauge is 1m = 1000mm wide, a thousandth of its width in pixels equals pixels per
      millimeter:
       */
      return (window.BD.get_rectangle(gauge, 'width')) / 1000;
    };
  })(this);

  this.GAUGE.get_rho = (function(_this) {
    return function(app, matter) {
      var gauge, jQuery, nominal_width, window;
      jQuery = app.jQuery, window = app.window;
      gauge = jQuery('#meter-gauge');
      nominal_width = parseInt(gauge.css('width'), 10);
      return nominal_width / window.BD.get_rectangle(gauge, 'width');
    };
  })(this);

  this.CARET = {};

  this.CARET.as_url = (function(_this) {
    return function(app, matter) {
      var caret, column_nr, file_locator, page_nr, y_px;
      file_locator = 'matter';
      caret = matter.caret;
      page_nr = caret['page-nr'];
      column_nr = caret['column-nr'];
      y_px = caret['y.px'];
      return "mkts://" + file_locator + "#page:" + page_nr + "/column:" + column_nr + "/y:" + y_px + "px";
    };
  })(this);

  this.VIEW = {};

  this.VIEW.toggle_galley = (function(_this) {
    return function(handler) {
      if (handler == null) {
        handler = null;
      }
      debug('©0fZv5', app['view']);
      if (app['view'] === 'pages') {
        return _this.VIEW.show_galley(handler);
      } else {
        return _this.VIEW.show_pages(handler);
      }
    };
  })(this);

  this.VIEW.show_galley = (function(_this) {
    return function(handler) {
      var q, window;
      if (handler == null) {
        handler = null;
      }
      window = app['window'];
      q = app['jQuery'];
      app['view'] = 'galley';
      app['pages-last-scroll-xy'][0] = (q(window)).scrollLeft();
      app['pages-last-scroll-xy'][1] = (q(window)).scrollTop();
      return (q('artboard.pages')).animate({
        opacity: 0
      }, function() {
        if (handler != null) {
          return handler(null);
        }
      });
    };
  })(this);

  this.VIEW.show_pages = (function(_this) {
    return function(handler) {
      var q, window;
      if (handler == null) {
        handler = null;
      }
      window = app['window'];
      q = app['jQuery'];
      app['view'] = 'pages';
      (q(window)).scrollLeft(app['pages-last-scroll-xy'][0]);
      (q(window)).scrollTop(app['pages-last-scroll-xy'][1]);
      return (q('artboard.pages')).animate({
        opacity: 1
      }, function() {
        if (handler != null) {
          return handler(null);
        }
      });
    };
  })(this);

  MKTS.open_print_dialog = function(me) {
    this.switch_to_print_view(me);
    window.print();
    return this.switch_to_dev_view(me);
  };

  MKTS.open_save_dialog = function(me) {
    throw new Error("not implemented");
  };

  MKTS.save = function(me) {
    throw new Error("not implemented");
  };

  MKTS.open_print_preview = function(me) {
    var script;
    this.switch_to_print_view(me);

    /* thx to http://apple.stackexchange.com/a/36947/59895, http://www.jaimerios.com/?p=171 */
    script = "tell application \"System Events\"\n  tell process \"mingkwai\"\n    keystroke \"p\" using {shift down, command down}\n    repeat until exists window \"Print\"\n    end repeat\n    click menu button \"PDF\" of window \"Print\"\n    repeat until exists menu item \"Open PDF in Preview\" of menu 1 of menu button \"PDF\" of window \"Print\"\n    end repeat\n    click menu item \"Open PDF in Preview\" of menu 1 of menu button \"PDF\" of window \"Print\"\n  end tell\nend tell";
    return APPLESCRIPT.execString(script, (function(_this) {
      return function(error) {
        if (error != null) {
          throw error;
        }
        _this.switch_to_dev_view(me);
        return help("MKTS.open_print_preview: ok");
      };
    })(this));
  };

  this.ACTIONS = {};

  this.ACTIONS['demo'];

  this.ACTIONS['demo-1'];

  this.ACTIONS['print'];

  this.ACTIONS['print-preview'];

  this.ACTIONS['open'];

  this.ACTIONS['save'];

  this.ACTIONS['save-as'];

  this.ACTIONS['view-test'] = (function(_this) {
    return function() {
      return window.location.href = './test.html';
    };
  })(this);

  this.ACTIONS['tool-mode-hand'] = (function(_this) {
    return function() {
      return _this.push_tool_mode('hand');
    };
  })(this);

}).call(this);
