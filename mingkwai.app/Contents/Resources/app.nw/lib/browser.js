// Generated by CoffeeScript 1.9.0
(function() {
  var CHR, CND, D, D$, LINESETTER, MKTS, NW, after, alert, app, badge, bindings, build_menu, debug, echo, help, immediately, info, keyboard, log, njs_fs, njs_path, on_file_menu_what_you_should_know_C, rpr, sleep, step, suspend, urge, warn, whisper, win, _demo;

  njs_path = require('path');

  njs_fs = require('fs');

  CND = require('cnd');

  rpr = CND.rpr.bind(CND);

  badge = '眀快排字机/browser';

  log = CND.get_logger('plain', badge);

  info = CND.get_logger('info', badge);

  alert = CND.get_logger('alert', badge);

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  urge = CND.get_logger('urge', badge);

  whisper = CND.get_logger('whisper', badge);

  help = CND.get_logger('help', badge);

  echo = CND.echo.bind(CND);

  NW = require('nw.gui');

  win = NW.Window.get();

  suspend = require('coffeenode-suspend');

  step = suspend.step;

  immediately = suspend.immediately;

  after = suspend.after;

  sleep = suspend.sleep;

  D = require('pipedreams2');

  D$ = D.remit.bind(D);

  CHR = require('coffeenode-chr');

  LINESETTER = require('./LINESETTER');

  MKTS = {};

  app = {
    'zoom-level': 0,
    'mm-per-px': 50 / 189,
    'jQuery': $,
    'MKTS': MKTS,
    'window': window
  };

  on_file_menu_what_you_should_know_C = function() {
    return ($('#content')).text("Some kind of interesting stuff.");
  };

  build_menu = function() {
    var edit_menu_item, file_menu, file_menu_entry, help_menu, help_menu_entry, win_menu;
    help_menu = new NW.Menu();
    help_menu.append(new NW.MenuItem({
      label: 'about 眀快排字机'
    }));
    help_menu.append(new NW.MenuItem({
      label: 'what you should know A'
    }));
    help_menu_entry = new NW.MenuItem({
      label: 'Help',
      'submenu': help_menu
    });
    file_menu = new NW.Menu();
    file_menu.append(new NW.MenuItem({
      label: 'New'
    }));
    file_menu.append(new NW.MenuItem({
      label: 'Open...',
      click: on_file_menu_what_you_should_know_C
    }));
    file_menu.append(new NW.MenuItem({
      label: 'Save',
      key: 's',
      modifiers: 'cmd',
      click: function() {
        return urge("saving...");
      }
    }));
    file_menu.append(new NW.MenuItem({
      label: 'Take Screenshot',
      key: 's',
      modifiers: 'cmd-shift',
      click: function() {
        return MKTS.take_screenshot(app);
      }
    }));
    file_menu_entry = new NW.MenuItem({
      label: 'File',
      'submenu': file_menu
    });
    win_menu = new NW.Menu({
      type: 'menubar'
    });
    win_menu.createMacBuiltin('眀快排字机');
    win_menu.insert(file_menu_entry, 1);
    win_menu.append(help_menu_entry);
    win.menu = win_menu;
    edit_menu_item = win.menu.items[2];
    edit_menu_item.submenu.insert(new NW.MenuItem({
      label: 'xxxxxxxxx'
    }), 1);
    return null;
  };

  build_menu();

  win.show();

  win.focus();

  win.zoomLevel = 0;

  win.setResizable(true);

  win.on('close', function() {
    info('close');
    return this.close(true);
  });

  MKTS.get_document_size = function(me) {
    return [($('html')).outerWidth(), ($('html')).outerHeight()];
  };

  MKTS.maximize = function(app) {
    win.moveTo(window.screen.availLeft, window.screen.availTop);
    return win.resizeTo(window.screen.availWidth, window.screen.availHeight);
  };

  MKTS.zoom_to = function(me, level) {

    /* TAINT code duplication */
    var base_zoom_level, zoom_percent;
    base_zoom_level = -0.15;
    win.zoomLevel = level != null ? level : base_zoom_level;
    zoom_percent = (win.zoomLevel - base_zoom_level) * 1.2 * 100;
    return win.zoomLevel;
  };

  MKTS.zoom = function(me, delta) {
    var base_zoom_level, zoom_percent;
    base_zoom_level = -0.15;
    if (delta != null) {
      if ((delta > 0 && win.zoomLevel <= 8.8) || (delta < 0 && win.zoomLevel >= -7.5)) {
        win.zoomLevel += delta;
      }
    } else {
      win.zoomLevel = base_zoom_level;
    }
    zoom_percent = (win.zoomLevel - base_zoom_level) * 1.2 * 100;
    return win.zoomLevel;
  };

  MKTS.print = function() {
    return print();
  };

  MKTS.wait = function(handler) {
    return window.requestAnimationFrame(function() {
      return handler();
    });
  };

  MKTS.take_screenshot = function() {
    return step((function(_this) {
      return function*(resume) {

        /* trying to wait for DOM reflow: */
        var img, img_route;
        (yield MKTS.wait(resume));
        img = (yield MKTS._capture(win, resume));
        img_route = '/tmp/nw.png';
        (yield njs_fs.writeFile(img_route, img, resume));
        return help("image written to " + img_route);
      };
    })(this));
  };

  MKTS.scroll_to = function(label) {
    return ($('html, body')).stop().animate({
      scrollTop: ($(label)).offset().top
    }, 500);
  };

  MKTS.scroll_to_top = function() {
    return this.scroll_to('#mkts-top');
  };

  MKTS.scroll_to_bottom = function() {
    return this.scroll_to('#mkts-bottom');
  };

  MKTS._capture = function(win, handler) {
    return win.capturePage(((function(_this) {
      return function(img) {
        return handler(null, img);
      };
    })(this)), {
      format: 'png',
      datatype: 'buffer'
    });
  };

  MKTS.foo = function(event) {
    return debug('©9HvgT', 'xxxx');
  };

  _demo = function() {
    var md;
    md = "# Through the Looking-Glass\n\n'Really, now you ask me,' said Alice, very much confused, 'I don't\nthink—'\n\n'Then you shouldn't talk,' said the Hatter.\n\nThis piece of rudeness was more than Alice could bear: she got up in\ngreat disgust, and walked off; the Dormouse fell asleep instantly, and\nneither of the others took the least notice of her going, though she\nlooked back once or twice, half hoping that they would call after her:\nthe last time she saw them, they were trying to put the Dormouse into\nthe teapot.\n\n'At any rate I'll never go THERE again!' said Alice as she picked her\nway through the wood. 'It's the stupidest tea-party I ever was at in all\nmy life!'\n\nJust as she said this, she noticed that one of the trees had a door\nleading right into it. 'That's very curious!' she thought. 'But\neverything's curious today. I think I may as well go in at once.' And in\nshe went.\n\nOnce more she found herself in the long hall, and close to the little\nglass table. 'Now, I'll manage better this time,' she said to herself,\nand began by taking the little golden key, and unlocking the door that\nled into the garden. Then she went to work nibbling at the mushroom (she\nhad kept a piece of it in her pocket) till she was about a foot high:\nthen she walked down the little passage: and THEN—she found herself at\nlast in the beautiful garden, among the bright flower-beds and the cool\nfountains.\n\n\nAlice opened the door and found that it led into a small passage, not\nmuch larger than a rat-hole: she knelt down and looked along the passage\ninto the loveliest garden you ever saw. How she longed to get out of\nthat dark hall, and wander about among those beds of bright flowers and\nthose cool fountains, but she could not even get her head through the\ndoorway; 'and even if my head would go through,' thought poor Alice, 'it\nwould be of very little use without my shoulders. Oh, how I wish I could\nshut up like a telescope! I think I could, if I only knew how to begin.'\nFor, you see, so many out-of-the-way things had happened lately,\nthat Alice had begun to think that very few things indeed were really\nimpossible.\n\n'Only mustard isn't a bird,' Alice remarked.\n\n'Right, as usual,' said the Duchess: 'what a clear way you have of\nputting things!'\n\n'It's a mineral, I THINK,' said Alice.\n\n'Of course it is,' said the Duchess, who seemed ready to agree to\neverything that Alice said; 'there's a large mustard-mine near here. And\nthe moral of that is--\"The more there is of mine, the less there is of\nyours.\"'\n\n'Oh, I know!' exclaimed Alice, who had not attended to this last remark,\n'it's a vegetable. It doesn't look like one, but it is.'\n\n'I quite agree with you,' said the Duchess; 'and the moral of that\nis--\"Be what you would seem to be\"--or if you'd like it put more\nsimply--\"Never imagine yourself not to be otherwise than what it might\nappear to others that what you were or might have been was not otherwise\nthan what you had been would have appeared to them to be otherwise.\"'\n\n'I think I should understand that better,' Alice said very politely, 'if\nI had it written down: but I can't quite follow it as you say it.'\n\n'That's nothing to what I could say if I chose,' the Duchess replied, in\na pleased tone.\n\n'Pray don't trouble yourself to say it any longer than that,' said\nAlice.\n\n'Oh, don't talk about trouble!' said the Duchess. 'I make you a present\nof everything I've said as yet.'\n\n'A cheap sort of present!' thought Alice. 'I'm glad they don't give\nbirthday presents like that!' But she did not venture to say it out\nloud.\n\n'Thinking again?' the Duchess asked, with another dig of her sharp\nlittle chin.\n\n'I've a right to think,' said Alice sharply, for she was beginning to\nfeel a little worried.\n\n'Just about as much right,' said the Duchess, 'as pigs have to fly; and\nthe m--'\n\nBut here, to Alice's great surprise, the Duchess's voice died away, even\nin the middle of her favourite word 'moral,' and the arm that was linked\ninto hers began to tremble. Alice looked up, and there stood the Queen\nin front of them, with her arms folded, frowning like a thunderstorm.\n\n'A fine day, your Majesty!' the Duchess began in a low, weak voice.\n\n'Now, I give you fair warning,' shouted the Queen, stamping on the\nground as she spoke; 'either you or your head must be off, and that in\nabout half no time! Take your choice!'\n\nThe Duchess took her choice, and was gone in a moment.\n\n'Let's go on with the game,' the Queen said to Alice; and Alice was\ntoo much frightened to say a word, but slowly followed her back to the\ncroquet-ground.\n\nThe other guests had taken advantage of the Queen's absence, and were\nresting in the shade: however, the moment they saw her, they hurried\nback to the game, the Queen merely remarking that a moment's delay would\ncost them their lives.\n\nAll the time they were playing the Queen never left off quarrelling with\nthe other players, and shouting 'Off with his head!' or 'Off with her\nhead!' Those whom she sentenced were taken into custody by the soldiers,\nwho of course had to leave off being arches to do this, so that by\nthe end of half an hour or so there were no arches left, and all the\nplayers, except the King, the Queen, and Alice, were in custody and\nunder sentence of execution.\n\nThen the Queen left off, quite out of breath, and said to Alice, 'Have\nyou seen the Mock Turtle yet?'\n\n'No,' said Alice. 'I don't even know what a Mock Turtle is.'\n\n'It's the thing Mock Turtle Soup is made from,' said the Queen.\n\n'I never saw one, or heard of one,' said Alice.\n\n'Come on, then,' said the Queen, 'and he shall tell you his history,'\n\nAs they walked off together, Alice heard the King say in a low voice,\nto the company generally, 'You are all pardoned.' 'Come, THAT'S a good\nthing!' she said to herself, for she had felt quite unhappy at the\nnumber of executions the Queen had ordered.\n\nThey very soon came upon a Gryphon, lying fast asleep in the sun.\n(IF you don't know what a Gryphon is, look at the picture.) 'Up, lazy\nthing!' said the Queen, 'and take this young lady to see the Mock\nTurtle, and to hear his history. I must go back and see after some\nexecutions I have ordered'; and she walked off, leaving Alice alone with\nthe Gryphon. Alice did not quite like the look of the creature, but on\nthe whole she thought it would be quite as safe to stay with it as to go\nafter that savage Queen: so she waited.\n\nThe Gryphon sat up and rubbed its eyes: then it watched the Queen till\nshe was out of sight: then it chuckled. 'What fun!' said the Gryphon,\nhalf to itself, half to Alice.\n\n'What IS the fun?' said Alice.\n\n'Why, SHE,' said the Gryphon. 'It's all her fancy, that: they never\nexecutes nobody, you know. Come on!'\n\n'Everybody says \"come on!\" here,' thought Alice, as she went slowly\nafter it: 'I never was so ordered about in all my life, never!'\n\nThey had not gone far before they saw the Mock Turtle in the distance,\nsitting sad and lonely on a little ledge of rock, and, as they came\nnearer, Alice could hear him sighing as if his heart would break. She\npitied him deeply. 'What is his sorrow?' she asked the Gryphon, and the\nGryphon answered, very nearly in the same words as before, 'It's all his\nfancy, that: he hasn't got no sorrow, you know. Come on!'\n\nSo they went up to the Mock Turtle, who looked at them with large eyes\nfull of tears, but said nothing.\n\n'This here young lady,' said the Gryphon, 'she wants for to know your\nhistory, she do.'\n\n'I'll tell it her,' said the Mock Turtle in a deep, hollow tone: 'sit\ndown, both of you, and don't speak a word till I've finished.'\n\nSo they sat down, and nobody spoke for some minutes. Alice thought to\nherself, 'I don't see how he can EVEN finish, if he doesn't begin.' But\nshe waited patiently.\n\n'Once,' said the Mock Turtle at last, with a deep sigh, 'I was a real\nTurtle.'\n\nThese words were followed by a very long silence, broken only by an\noccasional exclamation of 'Hjckrrh!' from the Gryphon, and the constant\nheavy sobbing of the Mock Turtle. Alice was very nearly getting up and\nsaying, 'Thank you, sir, for your interesting story,' but she could\nnot help thinking there MUST be more to come, so she sat still and said\nnothing.\n\n'When we were little,' the Mock Turtle went on at last, more calmly,\nthough still sobbing a little now and then, 'we went to school in the\nsea. The master was an old Turtle--we used to call him Tortoise--'\n\n'Why did you call him Tortoise, if he wasn't one?' Alice asked.\n\n'We called him Tortoise because he taught us,' said the Mock Turtle\nangrily: 'really you are very dull!'\n\n'You ought to be ashamed of yourself for asking such a simple question,'\nadded the Gryphon; and then they both sat silent and looked at poor\nAlice, who felt ready to sink into the earth. At last the Gryphon said\nto the Mock Turtle, 'Drive on, old fellow! Don't be all day about it!'\nand he went on in these words:\n\n'Yes, we went to school in the sea, though you mayn't believe it--'\n\n'I never said I didn't!' interrupted Alice.\n\n'You did,' said the Mock Turtle.\n\n'Hold your tongue!' added the Gryphon, before Alice could speak again.\nThe Mock Turtle went on.\n\n'We had the best of educations--in fact, we went to school every day--'\n\n'I'VE been to a day-school, too,' said Alice; 'you needn't be so proud\nas all that.'\n\n'With extras?' asked the Mock Turtle a little anxiously.\n\n'Yes,' said Alice, 'we learned French and music.'\n\n'And washing?' said the Mock Turtle.\n\n'Certainly not!' said Alice indignantly.\n\n'Ah! then yours wasn't a really good school,' said the Mock Turtle in\na tone of great relief. 'Now at OURS they had at the end of the bill,\n\"French, music, AND WASHING--extra.\"'\n";
    LINESETTER.demo(app, md);
    return null;
  };


  /*  * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*   * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*  * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*   * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*  * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*   * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*  * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /*   * # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # */


  /* TAINT should live in its own module */


  /* TAINT cosider using e.g. https://www.npmjs.com/package/combokeys */

  keyboard = new Map();

  keyboard.set(187, 'plus');

  keyboard.set(189, 'minus');

  keyboard.set(221, 'asterisk');

  keyboard.set(48, '0');

  keyboard.set(80, 'p');

  keyboard.set(81, 'q');

  keyboard.set(82, 'r');

  keyboard.set(83, 's');

  keyboard.set(89, 'y');

  keyboard.set(37, 'left');

  keyboard.set(39, 'right');

  bindings = {
    'meta+plus': function() {
      return MKTS.zoom(app, +1);
    },
    'meta+shift+asterisk': function() {
      return MKTS.zoom(app, +0.1);
    },
    'meta+0': function() {
      return MKTS.zoom(app, null);
    },
    'meta+minus': function() {
      return MKTS.zoom(app, -1);
    },
    'meta+shift+minus': function() {
      return MKTS.zoom(app, -0.1);
    },
    'meta+p': function() {
      return MKTS.print();
    },
    'meta+left': function() {
      return MKTS.scroll_to_top();
    },
    'meta+right': function() {
      return MKTS.scroll_to_bottom();
    },
    'meta+y': function() {
      return _demo();
    }
  };

  MKTS.on_keydown = function(event) {
    var binding, code, key_name, _ref, _ref1;
    code = (_ref = event.keyCode) != null ? _ref : event.which;
    key_name = [];
    if (event.altKey) {
      key_name.push('alt');
    }
    if (event.ctrlKey) {
      key_name.push('ctrl');
    }
    if (event.metaKey) {
      key_name.push('meta');
    }
    if (event.shiftKey) {
      key_name.push('shift');
    }
    key_name.push((_ref1 = keyboard.get(code)) != null ? _ref1 : code);
    key_name = key_name.join('+');
    echo(rpr(key_name), code);
    if ((binding = bindings[key_name]) != null) {
      binding();
      return false;
    } else {
      return true;
    }
  };

  win.on('document-end', function() {
    step(function*(resume) {
      MKTS.maximize(app);
      MKTS.zoom_to(app, 1.85);
      (yield step.wrap(($('document')).ready, resume));
      help("document ready");
      return ($(document)).keydown(MKTS.on_keydown.bind(MKTS));
    });
    return null;
  });

}).call(this);
